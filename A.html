<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <title>Xây dựng cấu hình</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --main: #2b90ef;
      --dark: #1f2937;
      --line: #e5e7eb;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: 'Times New Roman', serif;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 20px;
    }

    .cost {
      font-weight: bold;
      color: #2b90ef;
    }


    .page {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
    }

    .row {
      display: flex;
      border-top: 1px solid var(--line);
    }

    /* Dòng lẻ */
    .row:nth-child(odd) {
      background-color: #ffffff;
    }

    /* Dòng chẵn */
    .row:nth-child(even) {
      background-color: #f3f4f6;
    }

    /* Hover  */
    .row:hover {
      background-color: #e5f0ff;
    }


    .cell-left {
      width: 220px;
      padding: 10px;
      font-weight: bold;
    }

    .cell-right {
      flex: 1;
      padding: 10px;
    }

    .pick {
      background: var(--main);
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
    }

    .cost {
      margin: 10px 0;
      color: var(--main);
      font-weight: bold;
    }

    .btn {
      background: var(--main);
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: #fff;
      width: 500px;
      max-width: 90%;
      padding: 15px;
    }

    .item {
      border: 1px solid var(--line);
      padding: 10px;
      margin-bottom: 8px;
    }

    .item button {
      float: right;
      background: var(--main);
      color: #fff;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
    }

    .action-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .action-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 10px 14px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }

    .action-btn:hover {
      background: #dc2626;
    }

    .saved-item {
      border: 1px solid var(--line);
      padding: 10px;
      margin-bottom: 10px;
    }

    .saved-item b {
      color: var(--dark);
    }

    .saved-item button {
      margin-right: 6px;
      padding: 6px 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-load {
      background: #16a34a;
      color: #fff;
    }

    .btn-delete {
      background: #dc2626;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="title">CHỌN LINH KIỆN XÂY DỰNG CẤU HÌNH</div>

    <div class="topbar">
      <button class="btn" onclick="openReset()">LÀM MỚI</button>
      <div class="cost" id="total">Chi phí dự tính: 0 đ</div>
    </div>


    <div id="list"></div>
    <hr style="margin:40px 0">

    <h3>CẤU HÌNH ĐÃ LƯU</h3>
    <div id="savedBuilds"></div>

  </div>

  <!-- OVERLAY -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="modalList"></div>
      <button class="btn" onclick="closeModal()">Đóng</button>
    </div>
  </div>
  <!-- RESET MODAL -->
  <div class="overlay" id="resetOverlay">
    <div class="modal">
      <h3 style="margin-top:0">LÀM MỚI</h3>
      <p>
        Cảnh báo: Toàn bộ linh kiện của bộ PC hiện tại sẽ bị xóa đi
      </p>

      <div style="text-align:right;margin-top:20px">
        <button class="btn" style="background:#9ca3af" onclick="closeReset()">HỦY</button>
        <button class="btn" style="background:#dc2626" onclick="confirmReset()">XÁC NHẬN</button>
      </div>
    </div>
  </div>
  <!-- DELETE PART MODAL -->
  <div class="overlay" id="deleteOverlay">
    <div class="modal">
      <h3 style="margin-top:0">XÓA LINH KIỆN</h3>
      <p id="deleteText">Bạn có chắc muốn xóa linh kiện này?</p>

      <div style="text-align:right;margin-top:20px">
        <button class="btn" style="background:#9ca3af" onclick="closeDelete()">HỦY</button>
        <button class="btn" style="background:#dc2626" onclick="confirmDelete()">XÁC NHẬN</button>
      </div>
    </div>
  </div>


  <!-- EXPORT IMAGE ONLY SELECTED PARTS -->
  <div id="exportImageArea" style="
  position: fixed;
  left: -9999px;
  top: 0;
  width: 800px;
  background: #ffffff;
  padding: 20px;
  font-family: 'Times New Roman', serif;
">
    <h2 style="margin-top:0">CẤU HÌNH PC ĐÃ CHỌN</h2>
    <div id="exportList"></div>
    <hr>
    <div id="exportTotal" style="font-weight:bold"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const PARTS = [
      { key: "cpu", label: "Bộ vi xử lý" },
      { key: "main", label: "Bo mạch chủ" },
      { key: "ram", label: "RAM" },
      { key: "ssd", label: "SSD" },
      { key: "hdd", label: "HDD" },
      { key: "vga", label: "VGA" },
      { key: "psu", label: "Nguồn" },
      { key: "case", label: "Vỏ case" },
      { key: "monitor", label: "Màn hình" },
      { key: "keyboard", label: "Bàn phím" },
      { key: "mouse", label: "Chuột" },
      { key: "headset", label: "Tai nghe" },
      { key: "fan", label: "Fan case" },
      { key: "aircool", label: "Tản nhiệt khí" },
      { key: "aio", label: "Tản nhiệt nước AIO" },
      { key: "custom", label: "Tản nhiệt nước Custom" },
      { key: "windows", label: "Windows bản quyền" }
    ];


    const DATA = {
      cpu: [
        { name: "Intel Core i5-12400F", price: 3500000 },
        { name: "AMD Ryzen 5 5600X", price: 3900000 }
      ],
      main: [
        { name: "B660M", price: 2200000 },
        { name: "B760M", price: 2900000 }
      ],
      ram: [
        { name: "16GB DDR4", price: 1200000 },
        { name: "32GB DDR4", price: 2200000 }
      ],
      ssd: [
        { name: "SSD 512GB", price: 1300000 },
        { name: "SSD 1TB", price: 2300000 }
      ],
      hdd: [
        { name: "HDD 1TB", price: 900000 },
        { name: "HDD 2TB", price: 1500000 }
      ],
      vga: [
        { name: "RTX 3060", price: 7500000 },
        { name: "RTX 4060", price: 9500000 }
      ],
      psu: [
        { name: "650W Bronze", price: 1200000 },
        { name: "750W Gold", price: 1800000 }
      ],
      case: [
        { name: "Case Mid Tower", price: 1000000 },
        { name: "Case Full Tower", price: 1800000 }
      ],
      monitor: [
        { name: "24 inch FHD", price: 3000000 },
        { name: "27 inch QHD", price: 5200000 }
      ],
      keyboard: [
        { name: "Phím cơ", price: 600000 },
        { name: "Phím văn phòng", price: 300000 }
      ],
      mouse: [
        { name: "Chuột gaming", price: 400000 },
        { name: "Chuột văn phòng", price: 200000 }
      ],
      headset: [
        { name: "Tai nghe gaming", price: 800000 },
        { name: "Tai nghe thường", price: 400000 }
      ],
      fan: [
        { name: "Fan RGB", price: 300000 },
        { name: "Fan thường", price: 150000 }
      ],
      aircool: [
        { name: "Tản khí Cooler Master", price: 700000 },
        { name: "Tản khí Noctua", price: 1500000 }
      ],
      aio: [
        { name: "AIO 240mm", price: 2500000 },
        { name: "AIO 360mm", price: 4200000 }
      ],
      custom: [
        { name: "Custom cơ bản", price: 5000000 },
        { name: "Custom cao cấp", price: 9000000 }
      ],
      windows: [
        { name: "Windows 11 Home", price: 1200000 },
        { name: "Windows 11 Pro", price: 2500000 }
      ]
    };


    let build = JSON.parse(localStorage.getItem("pc_build")) || {};
    let currentKey = "";
    let deleteKey = "";
    (function loadFromShareLink() {
      const params = new URLSearchParams(window.location.search);
      const data = params.get("config");
      if (!data) return;

      try {
        const decoded = JSON.parse(
          decodeURIComponent(atob(data))
        );
        build = decoded;
        localStorage.setItem("pc_build", JSON.stringify(build));
      } catch (e) {
        console.error("Link cấu hình không hợp lệ");
      }
    })();


    function render() {
      let html = "";
      let total = 0;

      PARTS.forEach(p => {
        html += `
      <div class="row">
        <div class="cell-left">${p.label}</div>
        <div class="cell-right">
          <button class="pick" onclick="clickPart('${p.key}')">
            ${build[p.key] ? build[p.key].name + " ❌" : "+ Chọn " + p.label}
          </button>
        </div>
      </div>
    `;
        if (build[p.key]) total += build[p.key].price;
      });
      /* ===== ACTION BAR ===== */
      html += `
        <div class="row">
          <div class="cell-right">
            <div class="action-bar">
              <button class="action-btn" onclick="saveBuild()"> LƯU CẤU HÌNH</button>
              <button class="action-btn" onclick="exportExcel()">TẢI FILE EXCEL CẤU HÌNH</button>
              <button class="action-btn" onclick="exportImage()"> TẢI ẢNH</button>
              <button class="action-btn" onclick="shareBuild()">CHIA SẺ CẤU HÌNH</button>
              <button class="action-btn" onclick="printBuild()">XEM VÀ IN</button>
              <button class="action-btn" onclick="addToCart()">THÊM VÀO GIỎ HÀNG</button>
            </div>
          </div>
        </div>
      `;

      document.getElementById("list").innerHTML = html;
      document.getElementById("total").innerText =
        "Chi phí dự tính: " + total.toLocaleString() + " đ";
    }

    function clickPart(key) {
      if (build[key]) {
        deleteKey = key;
        document.getElementById("deleteText").innerText =
          "Bạn có chắc muốn xóa " + build[key].name + " ?";
        openDelete();
      } else {
        openModal(key);
      }
    }



    function openModal(key) {
      currentKey = key;
      document.getElementById("modalTitle").innerText =
        "Chọn " + PARTS.find(p => p.key === key).label;
      let list = "";
      DATA[key].forEach(i => {
        list += `
      <div class="item">
        <b>${i.name}</b> - ${i.price.toLocaleString()} đ
        <button onclick="selectItem('${i.name}',${i.price})">Chọn</button>
      </div>
    `;
      });
      document.getElementById("modalList").innerHTML = list;
      document.getElementById("overlay").style.display = "flex";
    }

    function selectItem(name, price) {
      build[currentKey] = { name, price };
      save();
      closeModal();
    }

    function closeModal() {
      document.getElementById("overlay").style.display = "none";
    }

    function save() {
      localStorage.setItem("pc_build", JSON.stringify(build));
      render();
    }
    function openReset() {
      document.getElementById("resetOverlay").style.display = "flex";
    }

    function closeReset() {
      document.getElementById("resetOverlay").style.display = "none";
    }
    function saveBuild() {
      if (Object.keys(build).length === 0) return;

      const saved = JSON.parse(localStorage.getItem("saved_builds")) || [];

      const newBuild = {
        id: Date.now(),
        time: new Date().toLocaleString(),
        build: JSON.parse(JSON.stringify(build))
      };

      saved.push(newBuild);
      localStorage.setItem("saved_builds", JSON.stringify(saved));

      renderSavedBuilds();
    }

    function renderSavedBuilds() {
      const saved = JSON.parse(localStorage.getItem("saved_builds")) || [];
      let html = "";

      if (saved.length === 0) {
        document.getElementById("savedBuilds").innerHTML =
          "<i>Chưa có cấu hình nào được lưu</i>";
        return;
      }

      saved.forEach(s => {
        let total = 0;
        let items = "";

        for (const k in s.build) {
          total += s.build[k].price;
          items += `<div>- ${s.build[k].name}</div>`;
        }

        html += `
      <div class="saved-item">
        <b>Thời gian:</b> ${s.time}<br>
        <b>Tổng tiền:</b> ${total.toLocaleString()} đ
        ${items}
        <div style="margin-top:8px">
          <button class="btn-load" onclick="loadBuild(${s.id})">Xem lại</button>
          <button class="btn-delete" onclick="deleteSavedBuild(${s.id})">Xóa</button>
        </div>
      </div>
    `;
      });

      document.getElementById("savedBuilds").innerHTML = html;
    }

    function loadBuild(id) {
      const saved = JSON.parse(localStorage.getItem("saved_builds")) || [];
      const item = saved.find(s => s.id === id);
      if (!item) return;

      build = JSON.parse(JSON.stringify(item.build));
      save();
    }

    function deleteSavedBuild(id) {
      let saved = JSON.parse(localStorage.getItem("saved_builds")) || [];
      saved = saved.filter(s => s.id !== id);
      localStorage.setItem("saved_builds", JSON.stringify(saved));
      renderSavedBuilds();
    }
    function openDelete() {
      document.getElementById("deleteOverlay").style.display = "flex";
    }

    function closeDelete() {
      document.getElementById("deleteOverlay").style.display = "none";
      deleteKey = "";
    }

    function confirmDelete() {
      if (deleteKey) {
        delete build[deleteKey];
        save();
      }
      closeDelete();
    }

    function confirmReset() {
      localStorage.removeItem("pc_build");
      build = {};
      render();
      closeReset();
    }
    function exportExcel() {
      if (Object.keys(build).length === 0) return;

      // Chuẩn bị dữ liệu cho Excel
      const rows = [
        ["Danh mục", "Linh kiện", "Giá (VND)"]
      ];

      let total = 0;

      for (const key in build) {
        const part = PARTS.find(p => p.key === key);
        rows.push([
          part ? part.label : key,
          build[key].name,
          build[key].price
        ]);
        total += build[key].price;
      }

      rows.push([]);
      rows.push(["", "TỔNG TIỀN", total]);

      // Tạo workbook & worksheet
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cau_hinh_PC");

      // Tên file
      const fileName = "Cau_hinh_PC_" + Date.now() + ".xlsx";

      // Xuất file
      XLSX.writeFile(wb, fileName);
    }
    function exportImage() {
      const listEl = document.getElementById("exportList");
      const totalEl = document.getElementById("exportTotal");

      listEl.innerHTML = "";
      totalEl.innerHTML = "";

      let total = 0;

      for (const key in build) {
        const part = PARTS.find(p => p.key === key);
        const item = build[key];

        const row = document.createElement("div");
        row.style.marginBottom = "8px";
        row.innerHTML = `
      <b>${part ? part.label : key}:</b>
      ${item.name}
      <span style="float:right">${item.price.toLocaleString()} đ</span>
    `;

        listEl.appendChild(row);
        total += item.price;
      }

      totalEl.innerHTML = "TỔNG TIỀN: " + total.toLocaleString() + " đ";

      const target = document.getElementById("exportImageArea");

      html2canvas(target, {
        scale: 2,
        backgroundColor: "#ffffff"
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "Cau_hinh_PC_da_chon.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }
    async function shareBuild() {
      if (Object.keys(build).length === 0) {
        alert("Chưa có cấu hình để chia sẻ");
        return;
      }

      const res = await fetch("http://localhost:3000/api/share", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(build)
      });

      const data = await res.json();

      const shareUrl =
        window.location.origin +
        "/view.html?id=" +
        data.id;

      await navigator.clipboard.writeText(shareUrl);
      alert("Đã tạo link chia sẻ:\n" + shareUrl);
    }


    function printBuild() {
      // In trang hiện tại (trình duyệt mở hộp thoại in)
      window.print();
    }

    function addToCart() {
      // Demo: lưu cấu hình hiện tại vào localStorage giỏ hàng
      if (Object.keys(build).length === 0) {
        alert("Bạn chưa chọn linh kiện nào!");
        return;
      }

      const cart = JSON.parse(localStorage.getItem("cart_builds")) || [];

      cart.push({
        id: Date.now(),
        time: new Date().toLocaleString(),
        build: JSON.parse(JSON.stringify(build))
      });

      localStorage.setItem("cart_builds", JSON.stringify(cart));

      alert("Đã thêm cấu hình vào giỏ hàng!");
    }
    render();
    renderSavedBuilds();



  </script>


</body>

</html>